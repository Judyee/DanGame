@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model DanGame.Models.GameViewModel

<style>
	.selected-item {
		color: white;
	}
</style>

<body class="area">
	<ul class="circles">
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
	</ul>

	<br>
	<br>
	<br>
	<br>

	<div class="container">
		<h2 class="text-center"
			style="width: 150px; margin: 20px; background: linear-gradient(to right, #e9b6e9, #d885ec, #bf91f0); border-radius: 10px; padding: 4px; color: white;">
			排行榜
		</h2>
		<div class="mx-3 mt-3 mb-4 mt-4">
			<div class="border rounded"
				 style="width: 100%; height: 130px; background-color: rgb(202, 202, 202, 0.3    );">
				<div>
					<dl class="d-flex">
						<dt style="margin: 10px;">已選</dt>
						<dd class="selected-item" style="margin: 10px;"></dd>
						<dd style="margin: 10px;">
							<a href="" class="reset"
							   style="text-decoration: none; color: black;">重置</a>
						</dd>
					</dl>
					<dl class="d-flex">
						<dt style="margin: 10px;">類別</dt>
						<div id="categories" style="margin: 10px;"></div>
					</dl>
				</div>
			</div>
		</div>

		<div id="app-detail" class="card mb-3 z-0 mx-3 mt-4 mb-4 modal_div_box">
			<div class="row g-0">
				<div class="col-md-4">
					<img id="app-image" src=""
						 class="img-fluid rounded-start" alt="...">
				</div>
				<div class="col-md-8">
					<div class="card-body" style="padding: 10px 10px 0 10px;">
						<h4 class="card-title mx-2" id="app-name"></h4>
						<div style="position: absolute; top: 15px; right: 50px; font-size: 15px;" id="app-downloads"> 下載次數 : </div>
						<div class="mb-3 mx-2">
							<p class="card-text border rounded" id="app-description"></p>
						</div>
						<div class="d-flex">
							<div>
								<p class="card-text">
									<small class="text-body-secondary border rounded-pill"
										   style="padding: 5px 15px; background-color: rgb(226, 226, 226);" id="app-genre"></small>
								</p>
							</div>
						</div>
						<div class="mt-3" style="position: absolute; bottom: 9%; left: 35%; font-size: 12px;" id="app-release-date"> 上架日期 : </div>
						<div class="text-end">
							<button class="btn btn-outline-primary" style="margin: 0 20px; position: absolute; bottom: 9%; right: 2%;">詳細資訊</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="text-center" style="margin-bottom: 50px;">
			<button class="btn btn-outline-light"
					style="font-size: 20px;">
				查看更多
			</button>
		</div>


	</div>
	<script src="~/lib/jquery/dist/jquery-3.7.1.min.js"></script>
	<script>
		$(document).ready(function () {
			let selectedItems = [];
			const maxSelection = 5;

			$("dl.d-flex dd a.list-group-item").click(function (e) {
				e.preventDefault();
				let selectedText = $(this).text();

				if (!selectedItems.includes(selectedText)) {
					if (selectedItems.length < maxSelection) {
						selectedItems.push(selectedText);
						$(".selected-item").text(selectedItems.join(", "));
					} else {
						alert("最多只能選擇5個類別");
					}
				}
			});

			$(".reset").click(function (e) {
				e.preventDefault();
				selectedItems = [];
				$(".selected-item").text("");
			});
		});

		const categoriesContainer = document.getElementById('categories');
		const appDetailContainer = document.getElementById('app-detail');

		fetch('http://localhost:5000/api/app', {
			method: 'GET', // 进行GET请求获取初始数据
			headers: {
				'Content-Type': 'application/json'
			}
		})
			.then(response => response.json())
			.then(appData => {
				console.log('Initial app data fetched:', appData); // 打印返回的appData

				// Check if appData.apps is a valid array and has at least one element
				if (appData && Array.isArray(appData.apps) && appData.apps.length > 0) {
					const firstAppId = appData.apps[0].appId; // 获取第一个应用的appId

					fetch('http://localhost:5000/api/app/GetAppByTags', {
						method: 'POST', // 修改为POST请求
						headers: {
							'Content-Type': 'application/json' // 设置Content-Type为application/json
						},
						body: JSON.stringify({ appId: firstAppId }) // 使用第一个应用的appId
					})
						.then(response => response.json())
						.then(categories => {
							console.log('Categories fetched:', categories);
							categories.forEach(category => {
								const ddElement = document.createElement('dd');
								ddElement.style.margin = '10px';

								const aElement = document.createElement('a');
								aElement.href = '#';
								aElement.className = 'list-group-item';
								aElement.textContent = category.tagName;
								aElement.addEventListener('click', () => displayApps(category.apps, category.tagName));

								ddElement.appendChild(aElement);
								categoriesContainer.appendChild(ddElement);
							});
						})
						.catch(error => {
							console.error('Error fetching categories:', error);
						});

					function displayApps(apps, genreTagName) {
						const appsContainer = document.getElementById('apps');
						appsContainer.innerHTML = ''; // 清空之前的应用列表

						apps.forEach(app => {
							const appElement = document.createElement('div');
							appElement.className = 'app-item';
							appElement.textContent = app.appName;
							appElement.addEventListener('click', () => fetchAppDetails(app.appId, genreTagName));
							appsContainer.appendChild(appElement);
						});
					}

					// Fetch app details based on tagId and genreTagName
					function fetchAppDetails(appId, genreTagName) {
						fetch('http://localhost:5000/api/app/AppsDetail', {
							method: 'POST', // 修改为POST请求
							headers: {
								'Content-Type': 'application/json' // 设置Content-Type为application/json
							},
							body: JSON.stringify({ appId: appId })
						})
							.then(response => response.json())
							.then(app => {
								console.log('App details fetched:', app);

								document.getElementById('app-image').src = app.HeaderImage;
								document.getElementById('app-name').textContent = app.AppName;
								document.getElementById('app-downloads').textContent = `下載次數 : ${app.Downloaded}`;
								document.getElementById('app-description').textContent = app.ShortDescription;
								document.getElementById('app-genre').textContent = genreTagName; // 使用从GetAppByTags获得的genreTagName
								document.getElementById('app-release-date').textContent = `上架日期 : ${app.ReleaseDate}`;

								appDetailContainer.style.display = 'block';
							})
					}
				}
			})

	</script>
</body>