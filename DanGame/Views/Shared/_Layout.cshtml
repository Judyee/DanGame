@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    var session = HttpContextAccessor.HttpContext?.Session;
    bool sessionExists = session != null && !string.IsNullOrEmpty(session.GetString("UserId"));
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - DanGame</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <link rel="stylesheet" href="~/css/style.css">
    <link rel="stylesheet" href="~/css/chatApp.css">

    @RenderSection("Styles",required: false)
</head>
<body>
    <header>
        @await Html.PartialAsync("_HeaderPartial")
    </header>
    <div>
        @RenderBody()
    </div>
    <footer>
        @await Html.PartialAsync("_FooterPartial")
    </footer>

    @* 防偽令牌 *@
    @Html.AntiForgeryToken()

    @RenderSection("Scripts", required: false)
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="~/js/site.js"></script>
    <script src="~/lib/jquery/dist/jquery-3.7.1.min.js"></script>
    <script src="~/lib/jqueryui/jquery-ui.js"></script>
    <script src="~/js/jquery-dateformat.min.js"></script>
    <script src="~/js/datepicker-zh-TW.js"></script>
    <script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>
    <script src="~/js/chatApp.js"></script>

</body>
</html>

<script>
    //購物車圖標model功能開始
    let myOffcanvas = $(`
                  <div class="offcanvas offcanvas-bottom mikecanvas" tabindex="-1" id="offcanvasBottom" aria-labelledby="offcanvasBottomLabel">
                      <div class="offcanvas-header mikecanvas_header">
                        <h5 class="offcanvas-title mikecanvas_title" id="offcanvasBottomLabel">快速檢視購物車</h5>
                        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                      </div>
                      <div class="offcanvas-body small mikecanvas_body">



                      </div>


                      <div class="canvasgotocheck">
                        <a href=""><i class="fa-solid fa-cart-shopping"></i> <b></b></a>
                    </div>



                    </div>
                `)
        .appendTo("body")
        .css({
            "border-radius": "30px 30px 30px 30px",
            margin: "20px 100px",
            height: "45vh",
            width: "90vw",
        });

    function rendermyOffcanvasGameItems(apps) {
        console.log("拿資料囉");
        console.log(apps); // 正确的变量名是 apps，而不是 aaps

        $.each(apps, function (index, app) {
            const myOffcanvasGameItem = $(`
                <div class="canvasgameitem" data-appid="${app.appId}">
                    <p class="canvasitem-name">${app.appName}</p>
                    <div class="itempic">
                        <a href=""><img src="https://steamcdn-a.akamaihd.net/steam/apps/${app.appId}/library_600x900.jpg" alt=""></a>
                    </div>
                    <div class="itemprice">
                        <p class="canvasGameItemrp">NT:${app.price}</p>
                    </div>
                    <i class="fa-solid fa-circle-minus deleticon"></i>
                </div>
            `);

            // 将创建的 myOffcanvasGameItem 添加到 .mikecanvas_body 中
            $(".mikecanvas_body").append(myOffcanvasGameItem);
            canvascalculate()
            myOffcanvasGameItem.find(".deleticon").on("click", function () {
                $(this).parent(".canvasgameitem").remove();
                console.log($(this).closest(".canvasgameitem").data("appid"))
                var canvanappid = $(this).closest(".canvasgameitem").data("appid")
                $.ajax({
                    method: "DELETE",
                    url: `delete/ShoppingCart/${canvanappid}`,
                    success: function (data) {
                        console.log("成功刪除");
                    },
                    error: function (xhr, status, error) {
                        console.log("刪除失敗", status, error);
                    }
                });

                canvascalculate();
            });
        });
    }

    //canvas的計算功能開始
    function canvascalculate() {
        let canvastotal = 0;
        myOffcanvas.find(".canvasGameItemrp").each(function () {
            let canvaspriceText = $(this).text().replace("NT:", "");
            let canvasprice = parseFloat(canvaspriceText);
            if (!isNaN(canvasprice)) {
                canvastotal += canvasprice;
            }
        });
        myOffcanvas.find(".canvasgotocheck b").text(canvastotal);
        if (canvastotal == 0) {
            myOffcanvasGameItem.find(".canvasgotocheck a").attr("href", "#");
            bsOffcanvas.hide();
        }
    }
    //建立model
    var bsOffcanvas = new bootstrap.Offcanvas(myOffcanvas);

    //點擊跳窗
    $(".bi-cart-plus").on("click", (event) => {
        event.preventDefault()
        // if (canvastotal == 0) {
        //     bsOffcanvas.block();
        // }
        bsOffcanvas.toggle();
        console.log("嗨");
    });

    //購物車圖標model功能結束
</script>
